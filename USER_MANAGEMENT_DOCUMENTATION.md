# ユーザー管理システム 完全ガイド

## 📌 はじめに

このドキュメントでは、実装したユーザー管理システムについて、非エンジニアの方でも理解できるように詳しく説明します。

## 🏗️ システムの全体像

### このシステムでできること

1. **ユーザーの一覧表示と管理**
   - すべてのユーザーを一覧で確認
   - ユーザーの検索やフィルタリング
   - 大量のユーザーをページ分けして表示

2. **ユーザーの詳細情報確認**
   - 個々のユーザーの詳しい情報を表示
   - ユーザーの活動履歴を追跡
   - 過去の警告や制裁の記録を確認

3. **ユーザーへのアクション実行**
   - 警告の送信
   - アカウントの一時停止
   - 永久BAN（アカウント凍結）
   - アカウントの復活

4. **権限管理**
   - 管理者（Admin）
   - モデレーター（Moderator）
   - 一般ユーザー（User）

5. **操作履歴の記録**
   - すべての管理操作を自動記録
   - いつ、誰が、何をしたかを追跡可能

## 📁 ディレクトリ構造と各ファイルの説明

```
secure-session-system/
│
├── app/                          # アプリケーションのメインフォルダ
│   ├── admin/                    # 管理者用画面
│   │   └── users/                # ユーザー管理機能
│   │       ├── page.tsx          # ユーザー一覧画面
│   │       └── [id]/             # 個別ユーザー用フォルダ
│   │           └── page.tsx      # ユーザー詳細画面
│   │
│   └── api/                      # API（データ通信用）フォルダ
│       └── admin/
│           └── users/
│               ├── route.ts      # ユーザー一覧・検索用API
│               └── [id]/
│                   └── route.ts  # 個別ユーザー操作用API
│
└── __tests__/                    # テストコード用フォルダ
    └── admin/
        └── users.test.ts         # ユーザー管理機能のテスト
```

### 各ファイルの役割（わかりやすく）

#### 🖥️ 画面ファイル（ユーザーが見る部分）

1. **`app/admin/users/page.tsx`** - ユーザー一覧画面
   - 例：Excelの表のようにユーザーを一覧表示
   - 検索ボックスでユーザーを探せる
   - フィルターで特定の条件のユーザーだけ表示

2. **`app/admin/users/[id]/page.tsx`** - ユーザー詳細画面
   - 例：個人の履歴書のような詳細情報ページ
   - その人の活動記録や警告履歴を確認

#### 🔧 APIファイル（データ処理部分）

3. **`app/api/admin/users/route.ts`** - ユーザーデータ管理API
   - データベースからユーザー情報を取得
   - 新しいユーザーの作成
   - 複数ユーザーへの一括操作

4. **`app/api/admin/users/[id]/route.ts`** - 個別ユーザー操作API
   - 特定ユーザーの情報取得・更新
   - 警告、停止、BAN等のアクション実行
   - 操作履歴の記録

#### 🧪 テストファイル

5. **`__tests__/admin/users.test.ts`** - 自動テスト
   - システムが正しく動作するか自動でチェック
   - バグを事前に発見

## 💻 画面の使い方

### 1. ユーザー一覧画面

```
┌─────────────────────────────────────────────────────┐
│  ユーザー管理                    [新規ユーザー作成]  │
├─────────────────────────────────────────────────────┤
│  🔍 検索 [___________]  権限[▼]  ステータス[▼]     │
├─────────────────────────────────────────────────────┤
│  □ メールアドレス    名前    権限    ステータス  操作│
│  □ user@example.com  山田    User    アクティブ  ⋮  │
│  □ admin@test.com   田中    Admin   アクティブ  ⋮  │
│  □ mod@test.com     佐藤    Mod     停止中      ⋮  │
├─────────────────────────────────────────────────────┤
│  < 1 2 3 4 5 >                      50件ずつ表示    │
└─────────────────────────────────────────────────────┘
```

**主な機能：**
- **検索ボックス**：メールアドレスや名前で検索
- **フィルター**：権限やステータスで絞り込み
- **チェックボックス**：複数選択して一括操作
- **操作メニュー（⋮）**：個別のアクション実行
- **ページング**：50件ずつ表示、ページ切り替え可能

### 2. ユーザー詳細画面

```
┌─────────────────────────────────────────────────────┐
│  ← ユーザー詳細                           [編集]    │
├─────────────────────────────────────────────────────┤
│  👤 山田太郎                                        │
│  📧 yamada@example.com                             │
│  🛡️ 権限: User  ✅ アクティブ                      │
│  📅 登録日: 2024/01/15                             │
│  🕐 最終ログイン: 2024/03/20 14:30                 │
├─────────────────────────────────────────────────────┤
│  [警告] [停止] [BAN] [復活]                        │
├─────────────────────────────────────────────────────┤
│  [アクティビティ] [権限履歴] [制裁履歴] [監査ログ]  │
│  ─────────────────────────────────────────────────  │
│  最近の活動履歴が表示されます...                    │
└─────────────────────────────────────────────────────┘
```

**タブの説明：**
- **アクティビティ**：ログイン履歴など
- **権限履歴**：権限変更の記録
- **制裁履歴**：警告や停止の記録
- **監査ログ**：管理者の操作記録

## 🔐 権限レベルの説明

### 1. **管理者（Admin）** 🔴
- すべての操作が可能
- ユーザーの権限変更
- BANや削除などの重要な操作

### 2. **モデレーター（Moderator）** 🟡
- 一般的な管理操作が可能
- 警告の送信
- 一時停止の実行

### 3. **一般ユーザー（User）** 🟢
- 通常のサービス利用のみ
- 管理機能へのアクセス不可

## 📊 ユーザーステータスの説明

| ステータス | 説明 | 表示色 |
|-----------|------|--------|
| **アクティブ** | 正常に利用可能 | 緑色 |
| **停止中** | 一時的に利用停止 | 黄色 |
| **BAN** | 永久に利用禁止 | 赤色 |
| **削除済み** | アカウント削除 | 灰色 |

## 🎯 主要な操作とその意味

### 1. **警告（Warning）** ⚠️
- **目的**：軽微な規約違反への注意喚起
- **効果**：記録が残るが、利用は継続可能
- **使用例**：不適切な発言への初回注意

### 2. **一時停止（Suspend）** 🚫
- **目的**：一定期間の利用制限
- **効果**：指定期間ログイン不可
- **使用例**：繰り返しの規約違反
- **期間**：デフォルト7日間（変更可能）

### 3. **永久BAN** 🔨
- **目的**：重大な違反への対処
- **効果**：永久にアカウント凍結
- **使用例**：悪質な行為、犯罪的行為

### 4. **復活（Reactivate）** ✅
- **目的**：制裁の解除
- **効果**：通常利用可能に戻す
- **使用例**：誤った処分の修正、期間終了

## 📝 操作履歴（監査ログ）の仕組み

すべての管理操作は自動的に記録されます：

```
例：監査ログの記録
─────────────────────────────────────
2024/03/20 15:30 | 管理者A | 警告送信
  対象: user@example.com
  理由: 不適切な投稿
─────────────────────────────────────
2024/03/19 10:15 | 管理者B | 権限変更
  対象: mod@test.com
  変更: User → Moderator
─────────────────────────────────────
```

**記録される情報：**
- 日時
- 実行した管理者
- 実行したアクション
- 対象ユーザー
- 理由や詳細

## 🔄 データの流れ（簡単な説明）

```
ユーザー操作の流れ：

1. 管理者が画面で操作
     ↓
2. APIがリクエストを受信
     ↓
3. データベースを更新
     ↓
4. 監査ログに記録
     ↓
5. 画面に結果を表示
```

## 🛠️ 技術的な特徴（簡単に）

### ページング（大量データの処理）
- **問題**：1万人のユーザーを一度に表示すると遅い
- **解決**：50人ずつに分けて表示
- **メリット**：高速な表示、サーバー負荷軽減

### 検索・フィルタ機能
- **リアルタイム検索**：入力と同時に結果更新
- **複数条件**：権限とステータスを組み合わせ可能
- **ソート機能**：名前や登録日で並び替え

### 一括操作
- **効率化**：複数ユーザーを選択して同時処理
- **使用例**：10人に一度に警告を送信

## ✅ テストによる品質保証

実装されたテストの種類：

1. **権限チェックテスト**
   - 権限に応じた操作制限の確認

2. **検索・フィルタテスト**
   - 検索機能の正確性確認

3. **アクションテスト**
   - 警告、停止、BAN等の動作確認

4. **監査ログテスト**
   - 操作履歴の正確な記録確認

## 📈 システムの利点

1. **透明性**：すべての操作が記録される
2. **効率性**：一括操作で時間短縮
3. **安全性**：権限による操作制限
4. **使いやすさ**：直感的なインターフェース
5. **拡張性**：将来の機能追加が容易

## 🚀 今後の拡張可能性

- **自動化**：特定条件での自動警告
- **分析機能**：ユーザー行動の統計分析
- **通知機能**：制裁時のメール通知
- **復旧機能**：誤操作の取り消し機能

## 📞 サポート情報

このシステムについて質問がある場合は、以下をご確認ください：

1. **操作方法**：各画面のヘルプボタン
2. **権限について**：管理者に問い合わせ
3. **技術的な問題**：システム管理者に連絡

---

このドキュメントは、ユーザー管理システムの全体像を理解するためのガイドです。
実際の操作前に、必要な権限があることを確認してください。