# 通報システムテストドキュメント

## テストファイル構成

### 1. `/tests/reporting-system.test.ts`
通報システムの単体テストを含むメインテストファイル

#### テストカバレッジ
- **ReportDialogコンポーネント**
  - 3ステップウィザードのレンダリング
  - 全通報カテゴリの表示
  - 優先度レベルの表示
  - カテゴリ選択の必須化
  - 説明文の最小文字数検証（10文字以上）
  - 送信前の確認画面表示
  - 成功時のフィードバックメッセージ

- **Report APIエンドポイント**
  - 新規通報の作成（POST /api/reports）
  - 重複通報の防止（409エラー）
  - 必須フィールドの検証
  - ターゲットタイプの検証
  - 管理者認証の確認（GET /api/reports）
  - 通報リストの取得

- **優先度計算**
  - カテゴリごとの基本優先度設定
  - 危険キーワードの検出（暴力、自殺、薬物など）
  - 複数通報による優先度上昇

- **虚偽通報検出**
  - 頻繁な通報の検出（24時間で5件以上）
  - 同一ターゲットへの繰り返し通報
  - 却下率による信頼度スコア
  - 最大スコア100の制限

- **フィードバック機能**
  - 優先度に基づく推定対応時間
  - 成功メッセージの表示
  - 適切なエラーメッセージ

- **高優先度通報の処理**
  - 優先度8以上での自動非表示

### 2. `/tests/integration/reporting-flow.test.ts`
統合テストファイル - 実際のデータベース接続を使用した完全なフローテスト

#### テストカバレッジ
- **完全な通報フロー**
  - 通報の送信から保存までの一連の流れ
  - データベースへの正しい保存
  - 監査ログの記録

- **重複防止機能**
  - 同一ユーザーからの重複通報防止

- **優先度システム**
  - 複数通報による優先度上昇
  - 暴力関連カテゴリの高優先度設定
  - 危険キーワードによる優先度調整
  - 通報者の信頼度による修飾子

- **虚偽通報検出システム**
  - 疑わしい通報パターンの検出
  - 同一ターゲットへの繰り返し通報
  - 高い却下率を持つユーザーのフラグ

- **高優先度アクション**
  - 優先度8以上でのコンテンツ自動非表示

- **管理者機能**
  - 管理者認証付きレポート取得
  - ステータスによるフィルタリング
  - 優先度によるソート

### 3. `/tests/setup.ts`
テスト環境のセットアップファイル
- Testing Libraryの設定
- Next.jsルーターのモック
- 環境変数の設定
- グローバルモックの設定

### 4. `/vitest.config.ts`
Vitestの設定ファイル
- JSdom環境の設定
- パスエイリアスの設定
- カバレッジレポートの設定
- テストファイルのパターン定義

## テストの実行

### 基本的なテストコマンド

```bash
# すべてのテストを実行
npm test

# テストをウォッチモードで実行
npm test -- --watch

# UIモードでテストを実行（ブラウザでテスト結果を確認）
npm run test:ui

# カバレッジレポートを生成
npm run test:coverage

# 統合テストのみを実行
npm run test:integration

# 特定のファイルのテストを実行
npm test reporting-system

# 特定のテストスイートを実行
npm test -- -t "Priority Calculation"
```

## 必要な環境変数

テスト実行前に以下の環境変数が必要です（tests/setup.tsで自動設定）：
- `MONGODB_URI`: MongoDBの接続文字列
- `JWT_SECRET`: JWTトークンの秘密鍵
- `ADMIN_SECRET_KEY`: 管理者認証キー

## モックとスタブ

### MongoDBのモック
- `mongodb`パッケージ全体をモック化
- コレクション操作のスタブを提供
- テストごとにリセット可能

### Next.jsのモック
- `useRouter`、`usePathname`、`useSearchParams`をモック
- ナビゲーション機能のスタブを提供

### Fetchのモック
- グローバル`fetch`関数をモック
- APIレスポンスのシミュレーション

## テストカバレッジ目標

- **行カバレッジ**: 80%以上
- **関数カバレッジ**: 85%以上
- **分岐カバレッジ**: 75%以上

## 継続的インテグレーション

GitHubActionsで自動実行される：
1. プルリクエスト作成時
2. メインブランチへのマージ時
3. 毎日の定期実行（オプション）

## トラブルシューティング

### よくある問題

1. **MongoDBの接続エラー**
   - 統合テスト用のテストデータベースを確認
   - 接続文字列の環境変数を確認

2. **タイムアウトエラー**
   - `vitest.config.ts`でタイムアウト時間を調整
   - 非同期処理の待機を確認

3. **モックが機能しない**
   - `vi.clearAllMocks()`が呼ばれているか確認
   - モックのセットアップ順序を確認

## 今後の改善点

1. E2Eテストの追加（Playwright使用）
2. パフォーマンステストの追加
3. ストレステストの実装
4. セキュリティテストの強化
5. ビジュアルリグレッションテスト